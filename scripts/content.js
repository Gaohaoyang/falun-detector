const youTuberList = [
  {
    name: 'New Century Films',
    linkKeywords: 'NewCenturyFilms',
  },
  {
    name: '放光明电视',
    linkKeywords: 'FGMTVorg',
  },
  {
    name: '希望之聲TV',
    linkKeywords: 'SOH_TV',
  },
  {
    name: '希望之聲 粵語TV',
    linkKeywords: 'SOH-Cantonese',
  },
  {
    name: '新聞看點 李沐陽',
    linkKeywords: 'MuYangShow',
  },
  {
    name: '天亮時分',
    linkKeywords: 'TianLiangTimes',
  },
  {
    name: '世界的十字路口 唐浩',
    linkKeywords: 'TangHaoCrossroads',
  },
  {
    name: '新聞拍案驚奇 大宇',
    linkKeywords: 'DayuShow',
  },
  {
    name: '調查報告 大宇',
    linkKeywords: 'dayureport',
  },
  {
    name: '江峰时刻',
    linkKeywords: 'JiangFengTimes',
  },
  {
    name: '蕭茗看世界',
    linkKeywords: 'user-tc3ev4bs8i',
  },
  {
    name: '睿眼看世界',
    linkKeywords: 'user-tp1lk6kj1g',
  },
  {
    name: '文昭談古論今',
    linkKeywords: 'wenzhaoofficial',
  },
  {
    name: '新唐人電視台',
    linkKeywords: 'NTDCHINESE',
  },
  {
    name: '中國禁聞',
    linkKeywords: 'Health8899-ml5ct',
  },
  {
    name: '弟子規動畫卡通',
    linkKeywords: 'heaven_kid_',
  },
  {
    name: '未解之謎 扶搖',
    linkKeywords: 'WJZM-FY',
  },
  {
    name: 'China Uncensored',
    linkKeywords: 'ChinaUncensored',
  },
  {
    name: 'America Uncovered',
    linkKeywords: 'AmericaUncovered',
  },
  {
    name: '老北京茶館',
    linkKeywords: 'BeijingTeahouse',
  },
  {
    name: '石濤.TV',
    linkKeywords: 'TVNo-dy2wx',
  },
  {
    name: 'Mr.姜光宇',
    linkKeywords: 'MrFunnyNewsJGY',
  },
  {
    name: '方菲時間',
    linkKeywords: 'fangfeitime',
  },
  {
    name: '郝毅博 Ben Hedges',
    linkKeywords: 'laowaikanzhongguo',
  },
  {
    name: '秦鵬觀察',
    linkKeywords: 'user-iz1qr7vh6j',
  },
  {
    name: '石山視點',
    linkKeywords: 'shishansoutlook7810',
  },
  {
    name: '珍言真語',
    linkKeywords: 'ZhenYanZhenYu',
  },
  {
    name: '遠見快評 唐靖遠',
    linkKeywords: 'TangJingYuan',
  },
  {
    name: '役情最前線 Zac主播',
    linkKeywords: 'zac2147',
  },
  {
    name: '新聞大破解',
    linkKeywords: 'News_Insight',
  },
  {
    name: '薇羽看世間',
    linkKeywords: 'weiyuksj',
  },
  {
    name: 'New Realm Studios',
    linkKeywords: 'NewsDetox',
  },
  {
    name: '真觀點',
    linkKeywords: 'zhenguandian',
  },
  {
    name: '橫河觀點',
    linkKeywords: 'hengheguandian',
  },
  {
    name: '紀元頭條頻道',
    linkKeywords: 'epochheadlines',
  },
  {
    name: '雅蘭訪談',
    linkKeywords: 'Yalantalk',
  },
  {
    name: '馨香雅句',
    linkKeywords: 'user-hn5rn5xv9m',
  },
  {
    name: '新世紀影視',
    linkKeywords: 'NCF',
  },
  {
    name: '人民报',
    linkKeywords: 'renminbao1',
  },
  {
    name: '《看中國》',
    linkKeywords: 'KZG',
  },
  {
    name: '阿波羅新聞網',
    linkKeywords: 'aboluowang',
  },
  {
    name: '阿波羅新聞網副頻道',
    linkKeywords: 'aboluowang2',
  },
  {
    name: 'FGMTV',
    linkKeywords: 'fgmtv673',
  },
  {
    name: 'chinaaffairs',
    linkKeywords: 'chinaaffairs',
  },
  {
    name: 'Shen Yun Official Account',
    linkKeywords: 'shenyun',
  },
  {
    name: '神韻藝術團中文官方頻道',
    linkKeywords: 'ShenYunChinese',
  },
  {
    name: '方偉時間',
    linkKeywords: 'FangWeiTime',
  },
  {
    name: 'Gan Jing World',
    linkKeywords: 'ganjingworld-official',
  },
]

const list = [
  {
    name: '新唐人电视台',
    linkKeywords: 'ntdtv.com',
  },
  {
    name: '爱博电视',
    linkKeywords: 'starp2p.com',
  },
  {
    name: '干净世界',
    linkKeywords: 'ganjingworld.com',
  },
  {
    name: 'Youmaker',
    linkKeywords: '/YoumakerVideo',
  },
  {
    name: 'Youmaker',
    linkKeywords: 'youmaker.com',
  },
  {
    name: '新世界影视',
    linkKeywords: 'thenewcenturyfilms.com',
  },
  {
    name: '大纪元',
    linkKeywords: 'epochtimes.com',
  },
  {
    name: '大纪元',
    linkKeywords: '/china_epoch',
  },
  {
    name: '大纪元',
    linkKeywords: 'djy.news',
  },
  {
    name: '大纪元',
    linkKeywords: '/dajiyuan',
  },
  {
    name: 'New Century Films',
    linkKeywords: 'thenewcenturyfilms.com',
  },
  {
    name: 'New Century Films',
    linkKeywords: '/NewCenturyFilms',
  },
  {
    name: '希望之声',
    linkKeywords: 'soundofhope.org',
  },
  {
    name: '希望之聲',
    linkKeywords: 'sohcradio.com',
  },
  {
    name: '希望之聲',
    linkKeywords: 'ozvoice.org',
  },
  {
    name: '希望之聲',
    linkKeywords: 'wanokokorosoh.com',
  },
  {
    name: '人民报',
    linkKeywords: 'renminbao.com',
  },
  {
    name: '人民报',
    linkKeywords: '/renminbao',
  },
  {
    name: '人民报',
    linkKeywords: 'renmin.bao',
  },
  {
    name: '看中国',
    linkKeywords: 'secretchina.com',
  },
  {
    name: '阿波罗网',
    linkKeywords: 'aboluowang.com',
  },
  {
    name: '阿波罗网',
    linkKeywords: '/aboluowang',
  },
  {
    name: '禁闻网',
    linkKeywords: 'bannedbook.org',
  },
  {
    name: '动态网',
    linkKeywords: 'dongtaiwang.com',
  },
  {
    name: '无界浏览',
    linkKeywords: 'www.wujieliulan.com',
  },
  {
    name: '放光明电视',
    linkKeywords: 'fgmtv.org',
  },
  {
    name: '放光明电视',
    linkKeywords: '/fgmtv_org',
  },
  {
    name: '宇明网',
    linkKeywords: 'yuming.qxbbs.org',
  },
  {
    name: '中国事务',
    linkKeywords: 'chinaaffairs.org',
  },
  {
    name: '明慧网',
    linkKeywords: 'minghui.org',
  },
  {
    name: '明慧网',
    linkKeywords: '/falun_dafa_minghui',
  },
  {
    name: '正见网',
    linkKeywords: 'zhengjian.org',
  },
  {
    name: '正见网',
    linkKeywords: '/realZhengJian',
  },
  {
    name: '法轮大法',
    linkKeywords: '/falundafamalaysia',
  },
  {
    name: '法轮大法',
    linkKeywords: '/FalunDafaAZ',
  },
  {
    name: '法轮大法',
    linkKeywords: 'falunaz.net',
  },
  {
    name: '亚太正悟网',
    linkKeywords: 'zhengwunet.org',
  },
  {
    name: '新生网',
    linkKeywords: 'xinsheng.net',
  },
  {
    name: '欧洲圆明网',
    linkKeywords: 'gb.yuanming.net',
  },
  {
    name: '澳洲光明网',
    linkKeywords: 'guangming.org',
  },
  {
    name: '神韵',
    linkKeywords: 'shenyun.com',
  },
  {
    name: '神韵',
    linkKeywords: 'shenyuncollections.com',
  },
  {
    name: '神韵',
    linkKeywords: 'www.shenyunshop.ca',
  },
  {
    name: '神韵',
    linkKeywords: 'shenyuncreations.com',
  },
  {
    name: '神韵',
    linkKeywords: 'shenyunperformingarts.org',
  },
  {
    name: '神韵',
    linkKeywords: '/ShenYunPerformingArts',
  },
  {
    name: '天梯书店',
    linkKeywords: 'tiantibooks.org',
  },
  {
    name: '博大出版社',
    linkKeywords: 'broadpressinc.com',
  },
  {
    name: '博大出版社',
    linkKeywords: 'broadpress.blogspot.com',
  },
  {
    name: '博大出版社',
    linkKeywords: '/bodatw',
  },
  {
    name: '天地行',
    linkKeywords: 'tiandixing.org',
  },
  {
    name: '自由网盟 internetfreedom',
    linkKeywords: 'internetfreedom.org',
  },
  {
    name: '追查国际',
    linkKeywords: 'zhuichaguoji.org',
  },
  {
    name: '全球退党服务中心',
    linkKeywords: 'tuidang.org',
  },
  {
    name: 'falundafa',
    linkKeywords: 'falundafa.org',
  },
  {
    name: '九评共产党',
    linkKeywords: 'ninecommentaries.com',
  },
]

const detectTextInYoutubeList = (url) => {
  let foundText = undefined
  const ownerDom = document.querySelector('#owner')
  document.querySelector('#owner')?.textContent || document.querySelector('#owner')?.innerText
  const uploadInfoContentATag = document.querySelector('#owner a')

  const urlPath = new URL(url).pathname

  youTuberList.forEach((item) => {
    // check url
    if (urlPath.toLowerCase().indexOf(item.linkKeywords.toLowerCase()) > -1) {
      foundText = item.name
      return
    }

    // check uploader
    if (
      ownerDom &&
      ownerDom.checkVisibility() &&
      ownerDom?.textContent?.toLowerCase().indexOf(item.name.toLowerCase()) > -1
    ) {
      foundText = item.name
      return
    }
    if (
      ownerDom &&
      ownerDom.checkVisibility() &&
      ownerDom?.textContent?.toLowerCase().indexOf(item.linkKeywords.toLowerCase()) > -1
    ) {
      foundText = item.name
      return
    }
    if (
      uploadInfoContentATag &&
      uploadInfoContentATag.checkVisibility() &&
      uploadInfoContentATag.href?.toLowerCase().indexOf(item.linkKeywords) > -1
    ) {
      foundText = item.name
      return
    }
  })
  return foundText
}

/**
 * @description Detect text in list
 * @param {String} url
 * @returns {String | undefined}
 */
const detectHostAndPathInList = (url) => {
  let foundText = undefined

  const urlHost = new URL(url).host
  const urlPath = new URL(url).pathname

  list.forEach((item) => {
    if (urlHost.toLowerCase().indexOf(item.linkKeywords.toLowerCase()) > -1) {
      foundText = item.name
      return
    }
    if (urlPath.toLowerCase().indexOf(item.linkKeywords.toLowerCase()) > -1) {
      foundText = item.name
      return
    }
  })

  return foundText
}

/**
 *
 * @description Render tip
 * @param {String} foundText
 *
 */
const renderTip = (foundText) => {
  const tipDom = document.querySelector('.falun-detector-tip')
  if (tipDom) {
    tipDom.style.display = 'flex'
    tipDom.querySelector('.falun-detector-tip-found-text').innerText = foundText
  } else {
    const html = `
      <div class="falun-detector-tip">
        <div>
          检测到页面包含
        </div>
        <div class="falun-detector-tip-small">
          Detected that the page contains
        </div>
        <span class="falun-detector-tip-found-text">${foundText}</span>
        <div>
          请注意可能是法轮功系相关的媒体或网页，请注意辨别。
        </div>
        <div class="falun-detector-tip-small">
          Please note that it may be media or web content related to the Falun Gong. Please discern accordingly.
        </div>
        <img class="falun-detector-tip-found-close" src="https://cdn.jsdelivr.net/gh/Gaohaoyang/pics/pics/xmark-solid.svg" alt="close" />
      </div>
    `
    document.body.insertAdjacentHTML('afterbegin', html)
  }
}

const hideTip = () => {
  const tipDom = document.querySelector('.falun-detector-tip')
  if (tipDom) {
    tipDom.style.display = 'none'
  }
}

const processTip = (foundText) => {
  if (foundText) {
    renderTip(foundText)
  } else {
    hideTip()
  }

  const closeDom = document.querySelector('.falun-detector-tip-found-close')
  const handleClose = () => {
    hideTip()
  }
  if (closeDom) {
    closeDom.removeEventListener('click', handleClose)
    closeDom.addEventListener('click', handleClose)
  }
}

const init = () => {
  chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {
    // listen for messages sent from background.js
    if (request.message === 'tabUpdatedSendFromFLDetector') {
      hideTip()
      const url = location.href
      if (url.indexOf('youtube.com') > -1) {
        setTimeout(() => {
          const foundText = detectTextInYoutubeList(url)
          processTip(foundText)
        }, 1800)
      } else {
        const foundText = detectHostAndPathInList(url)
        processTip(foundText)
      }
    }
  })
}

init()
